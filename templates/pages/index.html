{% extends theme('layouts/page.html') %}

{% block content %}
  {% include theme("sections/announcement.html") %}
  {% if node.properties.past_highlights %}
    {% include theme("sections/past-highlight.html") %}
  {% endif %}
  {% if node.properties.featured_talks %}
    {% include theme("sections/featured-talks.html") %}
  {% endif %}
  {% if node.properties.runup_events_list %}
    {% include theme("sections/runup-events-list.html") %}
  {% endif %}
  {% if node.properties.proposals %}
    {% include theme("sections/proposals.html") %}
  {% endif %}
  {% if node.properties.schedule %}
    {% include theme("sections/schedule.html") %}
  {% endif %}
  {% if node.properties.tickets %}
    {% include theme("sections/tickets.html") %}
  {% endif %}
  {% include theme("sections/venue.html") %}
  {% include theme("sections/sponsors-summary.html") %}
{% endblock %}

{% block header %}
  <header class="container-fluid">
    <div class="masthead">
      {% include theme("layouts/masthead.html") %}
    </div>
    <div class="row-fluid">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <h1 class="push-two-top push-one-bottom">
          <a class="ir center-block logo" href="/">
            {{ website.title }} {{ node.title }}
          </a>
        </h1>
        <div class="text-center heading-text">
          <h2 class="legible text1">{{ node.properties.tagline }}</h2>
          <h3 class="large text2">{{ node.properties.date }}, {{ node.properties.venue }}</h3>
          {% if node.properties.buy_ticket %}
            <p class="space-one"><a href="#tickets" class="button regular-prose dark smooth-scroll">Buy tickets</a></p>
          {% elif node.properties.propose_talk %}
            <p class="space-one"><a href="{{ node.properties.propose_talk }}" class="button regular-prose dark" target="_blank">Propose a talk</a></p>
          {% endif %}
        </div>
      </div>
    </div>
  {% block banner %}{% endblock %}
  </header>
{% endblock %}

{% block sitenav %}
  <div class="site-navbar">
    <div class="phone-menu clearfix">
      <h1 class="logo link-silent"><a href="#page" class="smooth-scroll"><img src="{{ theme_static('img/logo.png') }}"/></a></h1>
      <p id="menu-btn" class="menu white regular" data-target="#dropdown-menu"><i class="fa fa-bars"></i></p>
    </div>
    <nav class="nospace clearfix off" id="dropdown-menu">
      <ul class="link-silent clearfix">
        <li><a href="#about" class="smooth-scroll">Announcements</a></li>
        {% if node.properties.past_highlights %}
          <li><a href="#highlights" class="smooth-scroll">Past highlight</a></li>
        {% endif %}
        {% if node.properties.featured_talks %}
          <li><a href="#featured-talks" class="smooth-scroll">Featured talks</a></li>
        {% endif %}
        {% if node.properties.runup_events_list %}
          <li><a href="#runup-events" class="smooth-scroll">Runup events</a></li>
        {% endif %}
        {% if node.properties.proposals %}
          <li><a href="#proposals" class="smooth-scroll">Proposals</a></li>
        {% endif %}
        {% if node.properties.schedule %}
          <li><a href="#schedule" class="smooth-scroll">Schedule</a></li>
        {% endif %}
        {% if node.properties.tickets %}
          <li><a href="#tickets" class="smooth-scroll">Tickets</a></li>
        {% endif %}
        <li><a href="#venue" class="smooth-scroll">Venue</a></li>
        <li><a href="#sponsors" class="smooth-scroll">Sponsors</a></li>
        <li><a href="code-of-conduct">Code of conduct</a></li>
      </ul>
    </nav>
  </div>
{% endblock %}


{% block footerscripts %}
<style type="text/css">        
  #boxoffice-widget .boxoffice-button-action {        
    background-color: #FAA51A;        
    border-color:  #d98f15;       
    color: #fff;        
  }       
  #boxoffice-widget .boxoffice-button-info {        
    background-color: #5BC0DE;        
    border-color: #2A9CBE;        
    color: #fff;        
  }       
  #boxoffice-widget .payment-stages-bg {        
    background-color: #2E3661;        
  }       
  #boxoffice-widget .progress-indicator>li {        
    color: #FFF;        
  }
  #boxoffice-widget .progress-indicator>li.active, .progress-indicator > li.active .bubble {
    color: #337AB7;
  }  
  #boxoffice-widget .category-heading {       
    background-color: #549EAF;        
    border-bottom: 3px solid #44818f;       
    color: rgba(0,0,0,0.6);     
    line-height: 1.1;     
    font-weight: bold;   
  }       
  #boxoffice-widget .category-heading:after {       
    border-color: #549EAF #fff #549EAF #549EAF; 
  }   
</style> 

<script>
$(document).ready(function() {

  var logError = function (errorMsg) {
    $('#boxoffice-widget p').html(errorMsg);
    {% if g.user %}
      Raven.setUserContext({
        email: "{{ g.user.email }}",
        id: "{{ g.user.username }}"
      });
    {% endif %}
    Raven.captureMessage(errorMsg, {
      level: 'error',
      logger: 'boxoffice'
    });
    Jsfoo.sendGA('error', 'boxoffice load error', errorMsg);
    loadProposals();
    initLeaflets();
  }

  var loadBlog = function () {
    var url = "{{ node.properties.blog }}"
    if (url) {
      var blog = [];
      feednami.setPublicApiKey('27e9bf43bffd7b67277ff3639b85da428fac21bb4997f1964d4234c237c5e993');
      feednami.load(url).then(function(feed) {
        //Copy only six blog entries
        var entries = feed.entries.slice(0, 6);
        for(var index in entries) {
          entry = entries[index];
          //Remove img and iframe
          var description = entry.description.replace(/<img[^>]*>/g,"");
          description = description.replace(/<iframe[^>]*>/g,"");
          blog.push({"title": entry.title, "author":entry.author, "description": description, "link": entry.link})
        }
        Jsfoo.parseJson(blog, '#entries-wrapper', '#entries', 'blog');
      });
    }
  };

  var loadSchedule = function () {
    // For conference and workshop schedule
    var funnelurl = "{{ node.properties.propose_talk }}" + "schedule/json";
    //If schedule divs are present on the page, then make the ajax call.
    if(($('#conferenceschedule').length) || ($('#workshopschedule').length)) {
      $.ajax({
        type: 'GET',
        dataType: 'jsonp',
        url: funnelurl,
        success: function(data) {
          Jsfoo.parseScheduleJson(data, 'conference', '#conferenceschedule');
        }
      });//eof ajax call
    }
  };

  var loadProposals = function () {
    var proposals_url = "{{ node.properties.propose_talk }}" + 'json';

    //If funnel-proposals divs is present on the page, then make the ajax call.
    if(($('#funnel-proposals').length)) {
      $.ajax({
        type: 'GET',
        dataType: 'jsonp',
        url: proposals_url,
        success: function(data) {
          Jsfoo.parseProposalJson(data);
        }
      });//eof ajax call
    }
  };

  var boxofficeUrl = "https://boxoffice.hasgeek.com";
  var itemCollectionId = "{{ node.properties.item_collection }}"

  if (itemCollectionId) {
    $.get({
      url: boxofficeUrl + "/api/1/boxoffice.js",
      crossDomain: true,
      timeout: 8000,
      retries: 5,
      retryInterval: 8000,
      success: function(data) {
        var boxofficeScript = document.createElement('script');
        boxofficeScript.innerHTML = data.script;
        document.getElementsByTagName('body')[0].appendChild(boxofficeScript);
        window.Boxoffice.init({
          org: "hasgeek",
          itemCollection: itemCollectionId,
          paymentDesc: "{{ node.properties.payment_desc }}"
        });
        loadBlog();
        loadSchedule();
        loadProposals();
        initLeaflets();
      },
      error: function(response) {
        var ajaxLoad = this;
        ajaxLoad.retries -= 1;
        var errorMsg;
        if (response.readyState === 4) {
          errorMsg = "Server error, please try again later.";
          logError(errorMsg);
        }
        else if (response.readyState === 0) {
          if (ajaxLoad.retries < 0) {
            if(!navigator.onLine) {
              errorMsg = "Unable to connect. There is no network!";
              logError(errorMsg);
            }
            else {
              errorMsg = "Unable to connect. If you are behind a firewall or using any script blocking extension (like Privacy Badger). Please ensure your browser can load boxoffice.hasgeek.com, api.razorpay.com and checkout.razorpay.com .";
              logError(errorMsg);
            }
          } else {
            setTimeout(function() {
              $.get(ajaxLoad);
            }, ajaxLoad.retryInterval);
          }
        }
      }
    });
  }
  else {
    loadBlog();
    loadSchedule();
    loadProposals();
    initLeaflets();
  }

});
</script>
{% endblock %}